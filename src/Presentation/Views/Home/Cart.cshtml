@model List<Application.DTOs.ViewModels.BasketViewModel>
@{
    ViewBag.Title = "سبد خرید";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Metas {
    <meta name="description" content="فروشگاه اینترنتی موتورتو فعال در زمینه فروش انواع قطعات مصرفی خودرو شامل فیلتر روغن ، فیلتر هوا ، فیلتر بنزین ، فیلتر کابین ، روغن موتور و روانکار و غیره است .">
    <meta name="Keywords" content="قطعات مصرفی خودرو">
    <meta property="og:title" content="موتورتو ، فروش آنلاین قطعات خودرو | Motoreto" />
    <meta property="og:url" content="http://www.motoreto.ir/" />
    <meta property="og:image" content="http://www.motoreto.ir/images/sadr_logo.png" />
    <meta name="twitter:image" content="موتورتو ، فروش آنلاین قطعات خودرو | Motoreto">
    <meta name="robots" content="noindex">
}

@section Styles {
    <style>
        .maincontent-area, .latest-product {
            padding-bottom: 0px !important;
        }

        select {
            width: 78% !important;
        }

        @@media (max-width: 768px) {
            .btn-order {
                margin-bottom: 60px !important;
            }
        }
    </style>
}

<div class="container blog_header">
    <div class="row">
        <div class="col-md-12 text-center">
            <h1>سبد خرید</h1>
        </div>
    </div>
</div>

@if (TempData["Error"] != null)
{
    <div class="container text-center mt-4" style="direction:rtl !important;">
        <div class="alert alert-danger">@TempData["Error"]</div>
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="container text-center mt-4" style="direction:rtl !important;">
        <div class="alert alert-success">@TempData["Success"]</div>
    </div>
}

<div class="single-product-area">
    <div class="zigzag-bottom"></div>
    <div class="container">
        <div class="product-content-right">
            <div class="woocommerce">
                @if (Model.Any())
                {
                    <div class="table-responsive">
                        <table class="shop_table cart table-hover">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>تصویر</th>
                                    <th>عنوان</th>
                                    <th>تعداد</th>
                                    <th>مجموع به ریال</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    int pricewithdiscount = item.Product.DiscountPercent > 0
                                    ? item.Product.UnitPrice - (item.Product.UnitPrice * item.Product.DiscountPercent / 100)
                                    : item.Product.UnitPrice;

                                    var resultcount = item.Count * pricewithdiscount;
                                    <tr class="RMNT_item" id="cart-item-@item.Product.Id">
                                        <td>
                                            <a title="حذف محصول" class="remove btnRemove" productid="@item.Product.Id">
                                                <i class="fa fa-close"></i>
                                            </a>
                                        </td>
                                        <td>
                                            <a href="/Product/@item.Product.SefUrl">
                                                <img src="@(item.Product.SiteFirstImage ?? Url.Content("~/images/sadr_logo.png"))"
                                                     alt="@item.Product.PersianName" />
                                            </a>
                                        </td>
                                        <td>
                                            <a href="/Product/@item.Product.SefUrl">@item.Product.PersianName</a>
                                        </td>
                                        <td class="text-center">
                                            <div class="quantity buttons_added d-flex justify-content-center align-items-center">
                                                <input type="button" productid="@item.Product.Id" productPrice="@pricewithdiscount"
                                                       class="plus btn btn-orange" value="+" onclick="plus(this)" />
                                                <input type="number" disabled class="input-text qty text qtc text-center mx-2"
                                                       productPrice="@pricewithdiscount"
                                                       productid="@item.Product.Id"
                                                       value="@item.Count" min="@item.Product.Min" step="1" />
                                                <input type="button" productid="@item.Product.Id" productPrice="@pricewithdiscount"
                                                       class="minus btn btn-orange" value="-" onclick="minus(this)" />
                                            </div>
                                        </td>
                                        <td><span class="amount">@string.Format("{0:n0}", resultcount)</span></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-cart-wrap text-center">
                        <h3 class="empty-title">سبد خرید شما خالیه</h3>
                        <p class="empty-subtitle">برای شروع، از دسته‌بندی‌ها یکی رو انتخاب کن.</p>
                        <div class="empty-cta">
                            <a href="/#categories" class="btn btn-warning">مشاهده دسته‌بندی‌ها</a>
                            <a href="/#specialproducts" class="btn btn-primary" style="background-color:#00016e;border-color:#00016e">محصولات جدید</a>
                        </div>
                    </div>
                }

                @if (Model.Any())
                {
                    <form method="get" action="/Home/InsertOrder" class="shipping_calculator mt-3" id="SubmitOrder">
                        <input type="hidden" name="Type" value="1" />
                        <h2>
                            <a class="shipping-calculator-button"> روش های پرداخت <i class="fa fa-arrow-down"></i></a>
                        </h2>
                        <section id="calcalute-shipping-wrap" class="shipping-calculator-form">
                            <p>
                                <select name="PaymentType" required>
                                    <option value="0" selected>لطفا نوع پرداخت را تعیین نمایید</option>
                                    <option value="1">پرداخت درب منزل فقط تهران</option>
                                    <option disabled value="2">پرداخت آنلاین</option>
                                </select>
                            </p>
                            <p><button class="button btn-order" type="submit"> تکمیل سفارش <i class="fa fa-arrow-left"></i></button></p>
                        </section>
                    </form>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal حذف -->
<div class="modal fade" id="removeConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">تایید حذف</h5></div>
            <div class="modal-body">آیا از حذف این محصول مطمئن هستید؟</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">انصراف</button>
                <button type="button" class="btn btn-danger" id="confirmRemove">حذف</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function toPersianDigits(str) {
            return str.toString().replace(/\d/g, d => "۰۱۲۳۴۵۶۷۸۹"[d]);
        }
        function formatNumber(num) {
            return toPersianDigits(num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        }
        function updateWithAnimation($el, newValue) {
            $el.fadeOut(200, function () {
                $el.text(formatNumber(newValue)).fadeIn(300);
            });
        }
        function plus(element) {
            var $row = $(element).closest("tr");
            var $input = $row.find(".qtc");
            var count = parseInt($input.val()) + 1;
            var price = parseInt($(element).attr("productPrice"));
            var id = $(element).attr("productid");
            $input.val(count);
            updateWithAnimation($row.find(".product-subtotal span"), price * count);
            $.post("/Home/AddToShoppingCart", { Id: id }, function (result) {
                if (result.Success) {
                    updateWithAnimation($("#shoppingCount"), result.CountHtml);
                    updateWithAnimation($("#shoppingPrice"), result.PriceHtml);
                }
            });
        }
        function minus(element) {
            var $row = $(element).closest("tr");
            var $input = $row.find(".qtc");
            var count = parseInt($input.val());
            var price = parseInt($(element).attr("productPrice"));
            var id = $(element).attr("productid");
            if (count > 1) {
                count--;
                $input.val(count);
                updateWithAnimation($row.find(".product-subtotal span"), price * count);
                $.post("/Home/MinusFromShoppingCart", { Id: id }, function (result) {
                    if (result.Success) {
                        updateWithAnimation($("#shoppingCount"), result.CountHtml);
                        updateWithAnimation($("#shoppingPrice"), result.PriceHtml);
                    }
                });
            }
        }
        let productToRemove = null;
        $(".btnRemove").click(function (e) {
            e.preventDefault();
            productToRemove = $(this).attr("productid");
            rowToRemove = $(this).closest("tr");
            $("#removeConfirmModal").modal("show");
        });
        $("#confirmRemove").click(function () {
            if (!productToRemove) return;
            $.post("/Home/RemoveCart", { Id: productToRemove }, function (result) {
                if (result.Success) {
                    rowToRemove.fadeOut(400, function () { $(this).remove(); });
                    updateWithAnimation($("#shoppingCount"), result.CountHtml);
                    updateWithAnimation($("#shoppingPrice"), result.PriceHtml);
                }
            });
            $("#removeConfirmModal").modal("hide");
        });
    </script>
}
