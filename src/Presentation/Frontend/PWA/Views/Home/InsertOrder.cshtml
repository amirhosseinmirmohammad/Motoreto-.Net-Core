@using Application.DTOs.ViewModels
@model SubmitUserOrderViewModel
@{
    ViewBag.Title = "تکمیل سفارش";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Metas {
    <meta name="description" content="فروشگاه اینترنتی موتورتو فعال در زمینه فروش انواع قطعات مصرفی خودرو شامل فیلتر روغن ، فیلتر هوا ، فیلتر بنزین ، فیلتر کابین ، روغن موتور و روانکار و غیره است .">
    <meta name="Keywords" content="قطعات مصرفی خودرو">
    <meta property="og:title" content="موتورتو ، فروش آنلاین قطعات خودرو | Motoreto" />
    <meta property="og:url" content="http://www.motoreto.ir/" />
    <meta property="og:image" content="http://www.motoreto.ir/images/sadr_logo.png" />
    <meta name="twitter:image" content="http://www.motoreto.ir/images/sadr_logo.png">
    <meta name="robots" content="noindex">
}

@section Styles {
    <style>
        .col-md-4, .col-12:first-child {
            -webkit-box-shadow: 0 0 10px 0 rgba(47,48,51,.2);
            padding: 30px;
            margin-bottom: 40px;
        }

        p, a {
            line-height: 35px;
        }

        @@media (max-width: 768px) {
            .place-order {
                margin-bottom: 60px !important;
            }
        }

        #loginModal .modal-content {
            border-radius: 16px;
            padding: 20px;
        }

        #loginModal input[type="tel"] {
            border-radius: 10px;
            height: 45px;
            text-align: center;
            font-size: 16px;
        }

        #otpInputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

            #otpInputs .otp-input {
                width: 48px;
                height: 55px;
                font-size: 22px;
                font-weight: bold;
                text-align: center;
                border-radius: 10px;
                border: 1px solid #ddd;
            }

                #otpInputs .otp-input:focus {
                    border-color: #1a56db;
                    box-shadow: 0 0 5px rgba(26,86,219,0.5);
                }

        #loginModal .invalid-feedback {
            display: none;
            color: #d9534f;
            font-size: 12px;
        }

        #loginModal input.is-invalid + .invalid-feedback {
            display: block;
        }

        #otpError {
            display: none;
            margin-top: 10px;
        }

            #otpError.show {
                display: block;
            }

        #loginModal a.disabled {
            pointer-events: none;
            opacity: .5;
        }
    </style>
}

<div class="container blog_header">
    <div class="row">
        <div class="col-md-12 text-center">
            <h1>تکمیل سفارش</h1>
        </div>
    </div>
</div>

@if (Model.basket.Any())
{
    <form id="myform" asp-action="SubmitOrder" asp-controller="Home" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <input type="hidden" name="order.PaymentType" value="@Model.order.PaymentType" />
        <input type="hidden" name="order.Type" value="@Model.order.Type" />

        <div class="container">
            <h3>مبلغ نهایی قابل پرداخت</h3>
            <br />
            <table class="table shop_table">
                <thead>
                    <tr>
                        <th>محصول</th>
                        <th>تعداد</th>
                        <th>قیمت</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.basket)
                    {
                        <tr>
                            <td>@item.Product.PersianName</td>
                            <td>@item.Count</td>
                            <td>@string.Format("{0:n0}", item.Product.UnitPrice) ریال</td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="form-group">
                <label>کد تخفیف (اختیاری)</label>
                <input type="text" name="order.Discount" class="form-control" placeholder="کد تخفیف" />
            </div>

            <div class="form-group">
                <label>توضیحات (اختیاری)</label>
                @Html.TextAreaFor(m => m.order.UserOrderDescription, new { @class = "form-control", placeholder = "اگر توضیحاتی دارید وارد کنید..." })
            </div>

            <div class="form-check">
                <input type="checkbox" class="form-check-input" required />
                <label class="form-check-label">با ثبت سفارش، <a href="/terms">قوانین و مقررات</a> را می‌پذیرم.</label>
            </div>

            <br />
            <button type="button" id="place_order" class="btn btn-success">ثبت سفارش</button>
            <a href="/Home/Cart" class="btn btn-secondary">بازگشت</a>
        </div>
    </form>
}
else
{
    <div class="alert alert-warning text-center">سبد خرید شما خالی است.</div>
}

<!-- Modal تایید سفارش -->
<div class="modal fade" id="confirmOrderModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">آیا از ثبت این سفارش مطمئن هستید؟</div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">انصراف</button>
                <button class="btn btn-success" id="confirmSubmit">بله</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ورود/ثبت‌نام -->
<div class="modal fade" id="loginModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body" id="stepPhone">
                <h5 class="text-center">ورود / ثبت‌نام</h5>
                <input type="tel" id="phoneInput" class="form-control text-center" placeholder="۰۹xxxxxxxxx" maxlength="11" />
                <div class="invalid-feedback">شماره موبایل معتبر وارد کنید</div>
                <button id="sendCodeBtn" class="btn btn-primary w-100 mt-3">دریافت کد</button>
            </div>
            <div class="modal-body d-none" id="stepOtp">
                <h5 class="text-center">کد تایید</h5>
                <div id="otpInputs"></div>
                <div id="otpError" class="text-danger small text-center">کد اشتباه است</div>
                <button id="verifyCodeBtn" class="btn btn-success w-100 mt-3">تایید</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // تایید سفارش
        $("#place_order").click(() => $("#confirmOrderModal").modal("show"));
        $("#confirmSubmit").click(() => {
            $("#confirmOrderModal").modal("hide");
            $.get("/Account/IsAuthenticated", r => {
                if (r.isAuth) $("#myform").submit();
                else $("#loginModal").modal("show");
            });
        });

        // OTP
        let phone = "";
        const OTP_LEN = 5;
        function toEN(s){return s.replace(/[۰-۹]/g,d=>d.charCodeAt(0)-1776).replace(/[٠-٩]/g,d=>d.charCodeAt(0)-1632);}
        $("#sendCodeBtn").click(function(){
            let v=toEN($("#phoneInput").val());
            if(!/^09\d{9}$/.test(v)){ $("#phoneInput").addClass("is-invalid"); return; }
            phone=v;
            $.post("/Account/GenerateOrLogin",{phoneNumber:v}).done(()=>{
                buildOtp(); $("#stepPhone").hide(); $("#stepOtp").removeClass("d-none");
            });
        });
        function buildOtp(){
            const $w=$("#otpInputs").empty();
            for(let i=0;i<OTP_LEN;i++) $w.append('<input class="otp-input form-control" maxlength="1" />');
            $w.find("input").first().focus();
        }
        $(document).on("input",".otp-input",function(){
            this.value=toEN(this.value).replace(/\D/g,"").slice(0,1);
            if(this.value && this.nextElementSibling) this.nextElementSibling.focus();
        });
        $("#verifyCodeBtn").click(function(){
            let code=$(".otp-input").map(function(){return this.value;}).get().join("");
            if(code.length!==OTP_LEN)return;
            $.post("/Account/ApproveQuick",{phoneNumber:phone,code:code}).done(r=>{
                if(r.success){ $("#loginModal").modal("hide"); $("#myform").submit();}
                else $("#otpError").show();
            });
        });
    </script>
}
